# Query by Example

<!-- omit from toc -->

## Table of Contents

- [Query by Example Overview](#query-by-example-overview)
- [Setting Up Example-Based Queries](#setting-up-example-based-queries)
- [Creating Probe Objects](#creating-probe-objects)
- [Using Example Interface](#using-example-interface)
- [Switching to JPA Repository](#switching-to-jpa-repository)
- [Basic Query by Example Implementation](#basic-query-by-example-implementation)
- [Understanding Default Matching Behavior](#understanding-default-matching-behavior)
- [Customizing Matching with ExampleMatcher](#customizing-matching-with-examplematcher)
- [String Matching Options](#string-matching-options)
- [Including Null Values in Queries](#including-null-values-in-queries)
- [Excluding Fields from Queries](#excluding-fields-from-queries)
- [Query by Example Limitations](#query-by-example-limitations)
- [Key Points](#key-points)
- [Links/References](#linksreferences)

## Query by Example Overview

- **Dynamic querying**: Create queries by providing an example entity instead of writing specific query methods
- **Example-based approach**: Build queries dynamically based on values in an example object
- **Flexible criteria**: Set only the fields you want to use for searching
- **Runtime query generation**: Spring Data JPA constructs queries based on non-null field values

![Query by Example Concept](assets/query-by-example-concept.png)

**Key advantages:**
- **Reduced boilerplate**: No need to write multiple derived query methods
- **Dynamic conditions**: Query criteria determined at runtime
- **Simple syntax**: Intuitive approach using actual entity objects
- **Automatic query building**: Spring handles SQL generation

## Setting Up Example-Based Queries

- **Repository requirement**: Must use JPA Repository interface instead of CRUD Repository
- **Example support**: JPA Repository provides findAll() overloads that accept Example objects
- **Enhanced functionality**: JPA Repository extends CRUD Repository with additional query capabilities
- **Spring Data JPA feature**: Built-in support for example-based querying

```java
// Change from CrudRepository to JpaRepository
public interface ProductRepository extends JpaRepository<Product, Long> {
    // JpaRepository provides findAll(Example<S> example) methods
    // Additional JPA-specific methods available
}
```

![Repository Interface Hierarchy](assets/repository-interface-hierarchy.png)

## Creating Probe Objects

- **Probe definition**: Example entity object used as template for query criteria
- **Field-based matching**: Only non-null fields participate in query conditions
- **Entity instantiation**: Create new instance of target entity class
- **Selective field setting**: Set only the fields you want to match against

```java
// Create probe object
var product = new Product();
product.setName("product");  // Will be used in WHERE clause

// Other fields left null - ignored by default
// product.setPrice(null);    // Ignored
// product.setCategory(null); // Ignored
```

![Creating Probe Objects](assets/creating-probe-objects.png)

**Probe object rules:**
- **Non-null fields**: Included in query conditions
- **Null fields**: Ignored by default (can be overridden)
- **Entity structure**: Must match target entity class
- **Field values**: Actual values used for matching criteria

## Using Example Interface

- **Factory method**: Example.of() creates Example instances from probe objects
- **Static creation**: Example interface provides factory methods for object creation
- **Import requirement**: org.springframework.data.domain.Example
- **Probe wrapping**: Wraps probe object in Example interface for repository usage

```java
// Import Example interface
import org.springframework.data.domain.Example;

// Create example from probe
var product = new Product();
product.setName("product");

Example<Product> example = Example.of(product);
// Example wraps the probe for repository usage
```

![Example Interface Usage](assets/example-interface-usage.png)

## Switching to JPA Repository

- **Repository upgrade**: Change from CrudRepository to JpaRepository interface
- **Additional methods**: JPA Repository provides more query capabilities
- **Example support**: findAll(Example) methods available in JPA Repository
- **Backward compatibility**: JPA Repository extends CRUD Repository

```java
// Before - CrudRepository
public interface ProductRepository extends CrudRepository<Product, Long> {
    // Only basic CRUD operations
}

// After - JpaRepository  
public interface ProductRepository extends JpaRepository<Product, Long> {
    // CRUD operations + JPA-specific methods
    // Including findAll(Example<S> example)
}
```

![JPA Repository Upgrade](assets/jpa-repository-upgrade.png)

## Basic Query by Example Implementation

- **Service method**: Implement example-based querying in service layer
- **Probe creation**: Build example entity with desired search criteria
- **Example wrapping**: Use Example.of() to create queryable example
- **Repository call**: Pass example to repository findAll() method

```java
public void fetchProducts() {
    // 1. Create probe object
    var product = new Product();
    product.setName("product");
    
    // 2. Create example from probe
    Example<Product> example = Example.of(product);
    
    // 3. Query using example
    List<Product> products = productRepository.findAll(example);
    
    // 4. Process results
    products.forEach(System.out::println);
}
```

![Basic Query Implementation](assets/basic-query-implementation.png)

## Understanding Default Matching Behavior

- **Exact matching**: Default behavior uses equality operator (=) for all fields
- **Non-null fields**: Only fields with values participate in WHERE clause
- **SQL generation**: Spring generates standard SQL with exact field matches
- **Limitation awareness**: Exact matching may not find desired results for string searches

```java
// This probe
product.setName("product");

// Generates this SQL
// SELECT * FROM products WHERE name = 'product'
// May not find "Product 2" due to exact matching
```

![Default Matching Behavior](assets/default-matching-behavior.png)

**Generated SQL characteristics:**
- **WHERE clause**: Includes all non-null probe fields
- **Equality operators**: Uses = for exact field matching
- **Case sensitivity**: Database-dependent case handling
- **No wildcards**: No pattern matching in default behavior

## Customizing Matching with ExampleMatcher

- **Matcher creation**: ExampleMatcher.matching() starts matcher configuration
- **Builder pattern**: Chain method calls to customize matching behavior
- **String matching**: Configure how string fields are compared
- **Flexible queries**: Override default exact matching with pattern matching

```java
// Create custom matcher
ExampleMatcher matcher = ExampleMatcher.matching()
    .withStringMatcher(ExampleMatcher.StringMatcher.CONTAINING);

// Apply matcher to example
Example<Product> example = Example.of(product, matcher);

// Query with custom matching
List<Product> products = productRepository.findAll(example);
```

![ExampleMatcher Configuration](assets/examplematcher-configuration.png)

## String Matching Options

- **CONTAINING**: Matches substrings anywhere in field (LIKE %value%)
- **STARTING**: Matches values beginning with probe value (LIKE value%)
- **ENDING**: Matches values ending with probe value (LIKE %value)
- **EXACT**: Default exact equality matching
- **REGEX**: Regular expression pattern matching (database-dependent)

```java
// Different string matching options
ExampleMatcher containingMatcher = ExampleMatcher.matching()
    .withStringMatcher(ExampleMatcher.StringMatcher.CONTAINING);
    // WHERE name LIKE '%product%'

ExampleMatcher startingMatcher = ExampleMatcher.matching()
    .withStringMatcher(ExampleMatcher.StringMatcher.STARTING);
    // WHERE name LIKE 'product%'

ExampleMatcher endingMatcher = ExampleMatcher.matching()
    .withStringMatcher(ExampleMatcher.StringMatcher.ENDING);
    // WHERE name LIKE '%product'
```

![String Matching Options](assets/string-matching-options.png)

## Including Null Values in Queries

- **Default behavior**: Null fields ignored in query conditions
- **Include nulls**: withIncludeNullValues() includes null fields in WHERE clause
- **Null conditions**: Generates IS NULL conditions for null probe fields
- **Explicit null matching**: Useful for finding records with empty fields

```java
// Include null values in query
ExampleMatcher matcher = ExampleMatcher.matching()
    .withStringMatcher(ExampleMatcher.StringMatcher.CONTAINING)
    .withIncludeNullValues();

// This generates additional WHERE conditions:
// WHERE name LIKE '%product%' 
//   AND price IS NULL 
//   AND id IS NULL 
//   AND category_id IS NULL
```

![Including Null Values](assets/including-null-values.png)

## Excluding Fields from Queries

- **Field exclusion**: withIgnorePaths() removes specific fields from query conditions
- **Path specification**: Use property names to identify fields to ignore
- **Multiple fields**: Pass multiple field names to exclude several properties
- **Selective querying**: Control exactly which fields participate in matching

```java
// Exclude specific fields from query
ExampleMatcher matcher = ExampleMatcher.matching()
    .withStringMatcher(ExampleMatcher.StringMatcher.CONTAINING)
    .withIgnorePaths("id", "description");

// Generated SQL excludes specified fields:
// WHERE name LIKE '%product%' 
//   AND category_id IS NULL 
//   AND price IS NULL
// (id and description excluded)
```

![Excluding Fields from Queries](assets/excluding-fields-from-queries.png)

## Query by Example Limitations

- **No nested properties**: Cannot query on nested object fields or relationships
- **No collections**: Cannot match against collection or map properties
- **Database-specific strings**: String matching capabilities vary by database
- **Exact matching only**: Non-string types limited to exact equality matching
- **No range queries**: Cannot create range conditions (e.g., price between values)

![Query by Example Limitations](assets/query-by-example-limitations.png)

**Specific limitations:**
- **Nested queries**: Cannot use `product.getCategory().getName()` in probe
- **Collection matching**: Cannot match products with specific tags or attributes
- **Range conditions**: Cannot find products with `price > 100 AND price < 500`
- **Complex logic**: No support for OR conditions or complex WHERE clauses
- **Database dependency**: String matching features depend on underlying database

## Key Points

- **Main takeaway**: Query by Example allows dynamic query creation using example entity objects as templates, eliminating the need for hardcoded derived query methods
- **Repository requirement**: Must use JpaRepository instead of CrudRepository to access example-based query methods
- **Probe objects**: Create example entities with only the fields you want to match, leaving other fields null
- **Default behavior**: Uses exact matching (equality operators) for all non-null fields in the probe object
- **Custom matching**: Use ExampleMatcher to configure string matching behavior (CONTAINING, STARTING, ENDING, REGEX)
- **Null handling**: Null fields ignored by default, but can include them with withIncludeNullValues()
- **Field control**: Use withIgnorePaths() to exclude specific fields from query conditions
- **String flexibility**: Different string matching options generate appropriate LIKE clauses for pattern matching
- **Matching limitations**: Limited to exact matching for non-string types, no support for range queries or complex conditions
- **Structural restrictions**: Cannot query nested properties, collections, or use complex logical operators - consider Criteria API for advanced scenarios

## Links/References

- Video: 4.10.1-Query-by-Example.mp4 (06:03)
- Previous: [Writing Dynamic Queries](4.10.0-Writing-Dynamic-Queries.md)
- Next: Criteria API and Specifications
- Reference: [Spring Data JPA Query by Example](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#query-by-example)
- Reference: [ExampleMatcher Documentation](https://docs.spring.io/spring-data/commons/docs/current/api/org/springframework/data/domain/ExampleMatcher.html)

---

**Created**: July 31, 2025  
**Last Modified**: July 31, 2025
