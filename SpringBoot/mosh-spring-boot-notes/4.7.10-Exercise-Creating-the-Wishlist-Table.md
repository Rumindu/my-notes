# Exercise - Creating the Wishlist Table

<!-- omit from toc -->

## Table of Contents

- [Exercise Overview](#exercise-overview)
- [Exercise Requirements](#exercise-requirements)
- [Wishlist Relationship Design](#wishlist-relationship-design)
- [Implementing User-Product Relationship](#implementing-user-product-relationship)
- [Join Table Configuration](#join-table-configuration)
- [Unidirectional Relationship Choice](#unidirectional-relationship-choice)
- [Creating Migration with JPA Buddy](#creating-migration-with-jpa-buddy)
- [Reviewing Generated Changes](#reviewing-generated-changes)
- [Database Constraints](#database-constraints)
- [Managing Unwanted Changes](#managing-unwanted-changes)
- [Migration Execution](#migration-execution)
- [Database Verification](#database-verification)
- [Key Points](#key-points)
- [Links/References](#linksreferences)

## Exercise Overview

- **Business requirement**: Implement wishlist functionality for users and products
- **Relationship type**: Many-to-many between User and Product entities
- **Practice goal**: Apply model-first approach using JPA Buddy
- **Time estimate**: 10 minutes for implementation

![Wishlist Exercise Overview](assets/wishlist-exercise-overview.png)

**Wishlist concept:**
- User can have many products in wishlist
- Product can be in many users' wishlists
- Join table required for many-to-many relationship
- Real-world e-commerce functionality

## Exercise Requirements

- **Define relationship**: Many-to-many between User and Product entities
- **Join table specification**: Use @JoinTable with name "wishlist"
- **Migration creation**: Generate Flyway migration using JPA Buddy
- **Database result**: New wishlist table with foreign key constraints

![Exercise Requirements Checklist](assets/exercise-requirements-checklist.png)

**Expected database structure:**
- **users table**: Existing user data
- **products table**: Existing product data  
- **wishlist table**: New join table with user_id and product_id

## Wishlist Relationship Design

- **Many-to-many nature**: Multiple users can wishlist same product
- **Bidirectional potential**: Could navigate both directions
- **Business logic**: Wishlist belongs to user, products are wishlist items
- **Join table necessity**: Required for many-to-many relationships

![Wishlist Relationship Design](assets/wishlist-relationship-design.png)

**Relationship characteristics:**
- **User perspective**: User has collection of favorite products
- **Product perspective**: Product could have collection of users (optional)
- **Database implementation**: Join table with composite primary key
- **Business priority**: User-centric wishlist functionality

## Implementing User-Product Relationship

- **Collection field**: Add Set<Product> to User entity for favorite products
- **Set choice**: Prevents duplicate products in wishlist
- **Field naming**: "favoriteProducts" chosen (instructor notes "wishlist" would be better)
- **Initialization**: Initialize with new HashSet() for immediate use

```java
@Entity
@Table(name = "users")
public class User {
    // Other fields...
    
    @ManyToMany
    @JoinTable(
        name = "wishlist",
        joinColumns = @JoinColumn(name = "user_id"),
        inverseJoinColumns = @JoinColumn(name = "product_id")
    )
    private Set<Product> favoriteProducts = new HashSet<>();
    
    // Other methods...
}
```

![User Entity Wishlist Implementation](assets/user-entity-wishlist-implementation.png)

**Implementation details:**
- **Field type**: Set<Product> to prevent duplicates
- **Initialization**: new HashSet() for collection operations
- **Import requirement**: Import Product entity from entities package
- **Naming consideration**: "wishlist" would be more domain-appropriate

## Join Table Configuration

- **Owner designation**: User entity chosen as relationship owner
- **@JoinTable annotation**: Specifies join table details
- **Table name**: "wishlist" for business domain alignment
- **Column mapping**: Explicit foreign key column names

![Join Table Configuration Details](assets/join-table-configuration-details.png)

**@JoinTable attributes:**
- **name**: "wishlist" (join table name)
- **joinColumns**: @JoinColumn(name = "user_id") for owning entity
- **inverseJoinColumns**: @JoinColumn(name = "product_id") for target entity
- **Ownership flexibility**: Either User or Product could be owner

**Foreign key columns:**
- **user_id**: References users.id (owning side)
- **product_id**: References products.id (inverse side)
- **Composite key**: Both columns form primary key
- **Referential integrity**: Foreign key constraints ensure data consistency

## Unidirectional Relationship Choice

- **Business decision**: No need for Product → Users navigation
- **Practical consideration**: Products don't need to show all users who wishlisted them
- **Simplified implementation**: Only User → Products navigation needed
- **Performance benefit**: Avoid unnecessary bidirectional complexity

![Unidirectional Relationship Choice](assets/unidirectional-relationship-choice.png)

**Unidirectional benefits:**
- **Simpler code**: No reciprocal relationship in Product entity
- **Business alignment**: Wishlist is user-centric feature
- **Performance**: Avoid loading user collections for products
- **Maintenance**: Less code to maintain and debug

**When bidirectional might be needed:**
- **Analytics**: Show popular products by wishlist count
- **Marketing**: Target users who wishlisted specific products
- **Recommendations**: Products frequently wishlisted together

## Creating Migration with JPA Buddy

- **Warning detection**: JPA Buddy shows warnings for unmapped table
- **Migration trigger**: Use Alt + Enter or right-click migration approach
- **Default settings**: Accept default source/target configuration
- **Scope selection**: Include affected entities in migration

![JPA Buddy Migration Creation](assets/jpa-buddy-migration-creation.png)

**Migration creation steps:**
1. JPA Buddy detects model-database mismatch
2. Select "Create Flyway migration" from actions
3. Configure source (Model) and target (Database)
4. Review scope and entity selection
5. Proceed with migration generation

## Reviewing Generated Changes

- **Wishlist table creation**: Primary change for join table
- **Column specifications**: product_id and user_id as BIGINT NOT NULL
- **Composite primary key**: Both columns form primary key
- **Foreign key constraints**: References to users and products tables

![Generated Migration Changes](assets/generated-migration-changes.png)

**Expected changes:**
- **CREATE TABLE wishlist**: New join table creation
- **Composite primary key**: PRIMARY KEY (user_id, product_id)
- **Foreign key to products**: REFERENCES products(id)
- **Foreign key to users**: REFERENCES users(id)

```sql
-- Generated wishlist table structure
CREATE TABLE wishlist (
    user_id BIGINT NOT NULL,
    product_id BIGINT NOT NULL,
    PRIMARY KEY (user_id, product_id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (product_id) REFERENCES products(id)
);
```

![Wishlist Table SQL Structure](assets/wishlist-table-sql-structure.png)

## Database Constraints

- **Foreign key constraints**: Ensure referential integrity
- **Composite primary key**: Prevents duplicate user-product pairs
- **NOT NULL constraints**: Both foreign keys required
- **Referential integrity**: Automatic constraint validation

![Database Constraints Overview](assets/database-constraints-overview.png)

**Constraint benefits:**
- **Data integrity**: Prevents invalid user-product combinations
- **Uniqueness**: User can't wishlist same product twice
- **Referential integrity**: Invalid user/product IDs rejected
- **Performance**: Composite key enables efficient lookups

## Managing Unwanted Changes

- **Model mismatch**: Additional changes due to previous lessons
- **Change filtering**: Select and ignore unwanted modifications
- **Focus on wishlist**: Keep only wishlist-related changes
- **Ignore functionality**: Prevent unwanted changes in future migrations

![Managing Unwanted Migration Changes](assets/managing-unwanted-migration-changes.png)

**Change management strategy:**
- **Review all changes**: Identify wishlist-specific modifications
- **Select unwanted**: Choose changes not related to wishlist
- **Remove and ignore**: Prevent future inclusion of irrelevant changes
- **Clean migration**: Keep only intended wishlist functionality

## Migration Execution

- **Migration naming**: Set descriptive name "add wishlist"
- **SQL dialect**: Configure MySQL for better error checking
- **Maven execution**: Use flyway:migrate goal to apply changes
- **Success verification**: Confirm migration executed successfully

![Migration Execution Process](assets/migration-execution-process.png)

**Execution steps:**
1. **Name migration**: "add wishlist" for clear identification
2. **Configure dialect**: Set SQL dialect to MySQL
3. **Maven command**: Execute flyway:migrate goal
4. **Verify success**: Check migration output for errors

```bash
# Maven flyway migration command
mvn flyway:migrate
```

![Maven Flyway Migration Output](assets/maven-flyway-migration-output.png)

## Database Verification

- **Database refresh**: Update database view to see changes
- **Table verification**: Confirm wishlist table creation
- **Column structure**: Verify user_id and product_id columns
- **Constraint validation**: Check foreign key relationships

![Database Structure Verification](assets/database-structure-verification.png)

**Verification checklist:**
- **Wishlist table exists**: New table created successfully
- **Column structure**: user_id and product_id columns present
- **Data types**: Both columns are BIGINT NOT NULL
- **Primary key**: Composite primary key on both columns
- **Foreign keys**: Constraints reference users and products tables

![Wishlist Table Database View](assets/wishlist-table-database-view.png)

## Key Points

- **Main takeaway**: Many-to-many relationships require join tables with composite primary keys and foreign key constraints to both related entities
- **Model-first workflow**: JPA Buddy simplifies migration creation by detecting model-database differences and generating appropriate SQL scripts
- **Unidirectional choice**: Business requirements determine whether bidirectional navigation is necessary, with unidirectional being simpler for user-centric features
- **Owner flexibility**: Either entity can own many-to-many relationships since join table contains foreign keys for both entities
- **Join table naming**: Use business-domain names like "wishlist" rather than technical names for better code readability
- **Composite primary key**: Combination of foreign keys prevents duplicate relationships and ensures data integrity
- **Change management**: Migration tools detect all model differences, requiring careful review to include only intended changes
- **Field naming**: Choose descriptive field names that align with business domain (wishlist vs favoriteProducts)
- **SQL dialect configuration**: Setting database dialect improves error checking and SQL validation in migration tools
- **Verification importance**: Always verify database structure after migration to ensure changes applied correctly

## Links/References

- Video: 4.7.10-Exercise-Creating-the-Wishlist-Table.mp4 (04:31)
- Previous: [Model-First with JPA Buddy](4.7.9-Model-First-with-JPA-Buddy.md)
- Next: Advanced JPA Relationships
- Exercise: Practice many-to-many relationships with join tables
- Tool: [JPA Buddy Plugin](https://plugins.jetbrains.com/plugin/15075-jpa-buddy)

---

**Created**: July 31, 2025  
**Last Modified**: July 31, 2025
