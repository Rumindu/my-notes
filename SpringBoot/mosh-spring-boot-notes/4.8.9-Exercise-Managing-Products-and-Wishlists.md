# Exercise: Managing Products and Wishlists

<!-- omit from toc -->

## Table of Contents

- [Exercise Overview](#exercise-overview)
- [Exercise Steps Summary](#exercise-steps-summary)
- [Step 1: Creating Product with New Category](#step-1-creating-product-with-new-category)
- [Setting Up Builder Pattern](#setting-up-builder-pattern)
- [Creating Category Entity](#creating-category-entity)
- [Building Product with Category](#building-product-with-category)
- [Creating Product Repository](#creating-product-repository)
- [Transient Object Exception](#transient-object-exception)
- [Implementing Cascade Persist](#implementing-cascade-persist)
- [Step 2: Using Existing Category](#step-2-using-existing-category)
- [Category Repository Creation](#category-repository-creation)
- [Handling Byte Type Casting](#handling-byte-type-casting)
- [Detached Entity Exception](#detached-entity-exception)
- [Transaction Scope Solution](#transaction-scope-solution)
- [Step 3: Adding Products to Wishlist](#step-3-adding-products-to-wishlist)
- [Creating Add Favorite Method](#creating-add-favorite-method)
- [Unidirectional Relationship Design](#unidirectional-relationship-design)
- [Method Reference Optimization](#method-reference-optimization)
- [Step 4: Deleting Products](#step-4-deleting-products)
- [Foreign Key Constraint Issue](#foreign-key-constraint-issue)
- [Database Migration Solution](#database-migration-solution)
- [Key Points](#key-points)
- [Links/References](#linksreferences)

## Exercise Overview

- **Comprehensive exercise**: Combines multiple concepts from the section
- **Real-world scenario**: Product management with categories and wishlists
- **Error handling**: Multiple exceptions to troubleshoot and fix
- **Best practices**: Proper entity relationships and cascade management

![Exercise Overview Diagram](assets/exercise-managing-products-wishlists-overview.png)

**Learning objectives:**
- **Entity relationships**: Product-Category and User-Product associations
- **Cascade operations**: Automatic persistence and deletion
- **Transaction management**: Handling detached entities
- **Error resolution**: Common JPA/Hibernate exceptions

## Exercise Steps Summary

- **Step 1**: Create product with new category, fix transient object exception
- **Step 2**: Create product with existing category, handle detached entity
- **Step 3**: Add all products to user wishlist, observe SQL queries
- **Step 4**: Delete product, resolve foreign key constraint violation

![Exercise Steps Flow Chart](assets/exercise-steps-flow-chart.png)

**Step progression:**
1. **Basic persistence**: Simple entity creation and saving
2. **Entity fetching**: Working with existing entities
3. **Collection management**: Many-to-many relationship handling
4. **Cascade deletion**: Database constraint management

## Step 1: Creating Product with New Category

- **Method creation**: Add manageProducts method to UserService
- **Product creation**: Build new product entity with category
- **Initial approach**: Create both entities and attempt to save
- **Expected error**: Transient object exception

```java
@Service
public class UserService {
    
    public void manageProducts() {
        // Create product with new category
    }
}
```

![Manage Products Method Creation](assets/manage-products-method-creation.png)

## Setting Up Builder Pattern

- **Product entity**: Add @Builder annotation to Product class
- **Required annotations**: Include @AllArgsConstructor and @NoArgsConstructor
- **Clean object creation**: Enable fluent API for product building
- **Consistency**: Match pattern used in other entities

```java
@Entity
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class Product {
    // Entity fields and methods
}
```

![Product Builder Pattern Setup](assets/product-builder-pattern-setup.png)

## Creating Category Entity

- **Simple constructor**: Category only needs name parameter
- **Constructor creation**: Use Alt+Enter to generate constructor
- **NoArgsConstructor**: Add @NoArgsConstructor for JPA requirement
- **Minimal setup**: Category entity simpler than Product

```java
@Entity
@NoArgsConstructor
public class Category {
    
    public Category(String name) {
        this.name = name;
    }
    
    // Other fields and methods
}
```

![Category Entity Constructor](assets/category-entity-constructor.png)

## Building Product with Category

- **Product builder**: Use builder pattern for product creation
- **BigDecimal price**: Use BigDecimal.valueOf() for price setting
- **Category assignment**: Create new category and assign to product
- **Complete object**: Build product with all required fields

```java
public void manageProducts() {
    var category = new Category("Category 1");
    
    var product = Product.builder()
        .name("Product 1")
        .description("Description 1")
        .price(BigDecimal.valueOf(10.99))
        .category(category)
        .build();
}
```

![Product with Category Creation](assets/product-with-category-creation.png)

## Creating Product Repository

- **JPA Buddy generation**: Use JPA Buddy to create ProductRepository
- **Default configuration**: Accept default name and CrudRepository parent
- **Automatic field**: Repository field automatically added to service class
- **Repository usage**: Ready to use for product persistence

![Product Repository Creation](assets/product-repository-creation.png)

## Transient Object Exception

- **Exception type**: InvalidDataAccessApiUsageException
- **Root cause**: TransientObjectException from Hibernate
- **Problem description**: Product references unsaved (transient) category
- **Hibernate confusion**: Framework doesn't know how to handle transient reference

![Transient Object Exception](assets/transient-object-exception.png)

**Exception message analysis:**
```
Persistent instance references an unsaved transient instance of Category. 
Save the transient instance before flushing.
```

![Exception Message Detail](assets/exception-message-detail.png)

**Why exception occurs:**
- **Product persistence**: Product becomes persistent when saved
- **Category reference**: Product references transient category
- **Hibernate constraint**: Persistent objects cannot reference transient objects
- **Solution required**: Make category persistent first

## Implementing Cascade Persist

- **Annotation modification**: Add cascade = CascadeType.PERSIST to @ManyToOne
- **Automatic propagation**: Category saved automatically when product saved
- **Single operation**: One save call handles both entities
- **Clean solution**: More elegant than manual saves

```java
@Entity
public class Product {
    
    @ManyToOne(cascade = CascadeType.PERSIST)
    @JoinColumn(name = "category_id")
    private Category category;
}
```

![Cascade Persist Implementation](assets/cascade-persist-implementation.png)

**Successful execution:**
```sql
INSERT INTO categories (name) VALUES (?)
INSERT INTO products (name, description, price, category_id) VALUES (?, ?, ?, ?)
```

![Cascade Persist SQL Output](assets/cascade-persist-sql-output.png)

## Step 2: Using Existing Category

- **Existing entity**: Fetch category created in previous step
- **Category repository**: Create CategoryRepository using JPA Buddy
- **Entity retrieval**: Use findById() to get existing category
- **New product**: Create second product with fetched category

![Step 2 Overview](assets/step-2-overview.png)

## Category Repository Creation

- **JPA Buddy usage**: Generate CategoryRepository quickly
- **Repository pattern**: Follow same pattern as other repositories
- **Automatic integration**: Field added to service class automatically
- **Consistent approach**: Maintain consistency across repositories

![Category Repository Creation](assets/category-repository-creation.png)

## Handling Byte Type Casting

- **Data type issue**: Category ID declared as byte (tinyint in database)
- **Java default**: Numbers interpreted as integers by default
- **Casting requirement**: Must cast 1 to (byte) 1 for findById()
- **Design consideration**: Could use Integer instead of byte for simplicity

```java
// Byte casting required for tinyint/byte ID
var category = categoryRepository.findById((byte) 1).orElseThrow();

// Alternative: Use Integer ID to avoid casting
// private Integer id;  // In Category entity
```

![Byte Type Casting Issue](assets/byte-type-casting-issue.png)

**Casting trade-offs:**
- **byte advantage**: Minimal database space usage
- **byte disadvantage**: Requires casting, uglier code
- **Integer advantage**: No casting needed, cleaner code
- **Integer disadvantage**: Slightly more database space

## Detached Entity Exception

- **Exception type**: InvalidDataAccessApiUsageException
- **Root cause**: Detached entity passed to persist
- **Problem**: Category entity detached after repository method completes
- **Transaction boundary**: Repository transaction ends before product save

![Detached Entity Exception](assets/detached-entity-exception.png)

**Exception analysis:**
- **Category fetch**: findById() creates transaction, loads category, ends transaction
- **Category detachment**: Category becomes detached after transaction ends
- **Product save**: Attempts to save product with detached category reference
- **Hibernate rejection**: Cannot persist entity with detached references

## Transaction Scope Solution

- **@Transactional annotation**: Apply to manageProducts method
- **Extended context**: Keep persistence context active throughout method
- **Entity management**: Category remains managed during product save
- **Single transaction**: All operations within same transaction boundary

```java
@Transactional
public void manageProducts() {
    var category = categoryRepository.findById((byte) 1).orElseThrow();
    
    var product = Product.builder()
        .name("Product 2")
        .description("Description 2")
        .price(BigDecimal.valueOf(15.99))
        .category(category)
        .build();
    
    productRepository.save(product);
}
```

![Transactional Annotation Solution](assets/transactional-annotation-solution.png)

**Successful execution:**
```sql
SELECT ... FROM categories WHERE id = ?
INSERT INTO products (name, description, price, category_id) VALUES (?, ?, ?, ?)
```

![Step 2 Successful SQL](assets/step-2-successful-sql.png)

## Step 3: Adding Products to Wishlist

- **User retrieval**: Fetch existing user from database
- **Product fetching**: Get all products using findAll()
- **Wishlist population**: Add each product to user's favorite products
- **Batch operation**: Process all products in single transaction

```java
@Transactional
public void manageProducts() {
    var user = userRepository.findById(2L).orElseThrow();
    var products = productRepository.findAll();
    
    products.forEach(user::addFavoriteProduct);
    userRepository.save(user);
}
```

![Wishlist Population Code](assets/wishlist-population-code.png)

## Creating Add Favorite Method

- **Helper method**: Create addFavoriteProduct method in User entity
- **Collection management**: Add product to favoriteProducts collection
- **Unidirectional relationship**: Only User knows about favoriteProducts
- **Business logic**: No requirement to show users per product

```java
@Entity
public class User {
    
    public void addFavoriteProduct(Product product) {
        favoriteProducts.add(product);
    }
}
```

![Add Favorite Product Method](assets/add-favorite-product-method.png)

## Unidirectional Relationship Design

- **Design decision**: Product entity doesn't reference users
- **Business requirement**: No need to show users who favorited product
- **Simpler model**: Reduces complexity and memory usage
- **Performance benefit**: Fewer queries and relationships to manage

![Unidirectional Relationship Design](assets/unidirectional-relationship-design.png)

**Unidirectional benefits:**
- **Simplified model**: Fewer relationships to manage
- **Clear ownership**: User owns the wishlist relationship
- **Performance**: No inverse collection loading
- **Business alignment**: Matches actual requirements

## Method Reference Optimization

- **Lambda to method reference**: IntelliJ suggests optimization
- **Cleaner syntax**: user::addFavoriteProduct more concise
- **Functional programming**: Modern Java style
- **Readability**: Often more readable than lambda expressions

```java
// Before: Lambda expression
products.forEach(product -> user.addFavoriteProduct(product));

// After: Method reference
products.forEach(user::addFavoriteProduct);
```

![Method Reference Optimization](assets/method-reference-optimization.png)

**Wishlist insertion results:**
```sql
INSERT INTO wishlist (user_id, product_id) VALUES (?, ?)
INSERT INTO wishlist (user_id, product_id) VALUES (?, ?)
```

![Wishlist SQL Inserts](assets/wishlist-sql-inserts.png)

## Step 4: Deleting Products

- **Product deletion**: Attempt to delete product by ID
- **Foreign key constraint**: Product referenced in wishlist table
- **Exception expectation**: Data integrity violation
- **Resolution approach**: Database-level cascade deletion

```java
@Transactional
public void manageProducts() {
    productRepository.deleteById(4L);
}
```

![Product Deletion Attempt](assets/product-deletion-attempt.png)

## Foreign Key Constraint Issue

- **Exception type**: DataIntegrityViolationException
- **Constraint violation**: Cannot delete product with wishlist references
- **Database protection**: ON DELETE NO ACTION prevents deletion
- **Wishlist table**: Foreign key constraint blocks product deletion

![Foreign Key Constraint Error](assets/foreign-key-constraint-error.png)

**Constraint analysis:**
- **Wishlist table**: Contains foreign key to products table
- **ON DELETE action**: Set to NO ACTION (prevents deletion)
- **Solution options**: Change to CASCADE or handle in application
- **Database approach**: Modify foreign key constraint

## Database Migration Solution

- **Migration approach**: Create new Flyway migration for constraint modification
- **Constraint modification**: Change ON DELETE NO ACTION to ON DELETE CASCADE
- **Version control**: Properly version database schema changes
- **Team coordination**: Ensure all developers get schema updates

![Database Migration Creation](assets/database-migration-creation.png)

**Migration file creation:**
```sql
-- V9__enable_cascade_on_wishlist.sql
ALTER TABLE wishlist 
DROP FOREIGN KEY fk_wishlist_product_id;

ALTER TABLE wishlist 
ADD CONSTRAINT fk_wishlist_product_id 
FOREIGN KEY (product_id) REFERENCES products(id) 
ON DELETE CASCADE;
```

![Migration SQL Content](assets/migration-sql-content.png)

**Migration execution:**
```bash
# Run Flyway migration
flyway:migrate
```

![Migration Execution](assets/migration-execution.png)

**Successful product deletion:**
```sql
DELETE FROM products WHERE id = ?
-- Database automatically deletes from wishlist table due to CASCADE
```

![Successful Product Deletion](assets/successful-product-deletion.png)

## Key Points

- **Main takeaway**: Complex entity relationships require careful handling of cascade operations, transaction boundaries, and database constraints
- **Transient object handling**: Use cascade = CascadeType.PERSIST to automatically save related entities when parent is saved
- **Detached entity solution**: Apply @Transactional to service methods to keep entities managed throughout operation
- **Transaction scope importance**: Entity state (transient, persistent, detached) depends on transaction boundaries
- **Builder pattern benefits**: Provides clean, readable object construction especially for entities with many fields
- **Type casting considerations**: Using byte/tinyint types requires casting but saves database space - consider trade-offs
- **Unidirectional relationships**: Design relationships based on actual business requirements, not assumption of bidirectionality
- **Foreign key constraints**: Database constraints protect data integrity but may require cascade configuration for deletion operations
- **Migration best practices**: Use Flyway migrations to version database schema changes rather than direct database modifications
- **Method references**: Use method references over lambda expressions when possible for cleaner, more readable code

## Links/References

- Video: 4.8.9-Exercise-Managing-Products-and-Wishlists.mp4 (11:48)
- Previous: [Deleting Related Entities](4.8.8-Deleting-Related-Entities.md)
- Next: Advanced JPA Concepts
- Reference: [JPA Cascade Types](https://docs.oracle.com/javaee/7/api/javax/persistence/CascadeType.html)
- Reference: [Flyway Database Migrations](https://flywaydb.org/documentation/concepts/migrations)

---

**Created**: July 31, 2025  
**Last Modified**: July 31, 2025
