# Database Migrations with Flyway

<!-- omit from toc -->

## Table of Contents

- [Database Versioning Overview](#database-versioning-overview)
- [The Problem with Visual Design](#the-problem-with-visual-design)
- [Introduction to Flyway](#introduction-to-flyway)
- [Setting Up Flyway](#setting-up-flyway)
  - [Adding Flyway Dependencies](#adding-flyway-dependencies)
  - [Creating Migration Directory Structure](#creating-migration-directory-structure)
- [Migration File Conventions](#migration-file-conventions)
  - [Naming Convention Rules](#naming-convention-rules)
  - [Creating Migration Files](#creating-migration-files)
- [Generating Migration Scripts](#generating-migration-scripts)
  - [SQL Script Generation](#sql-script-generation)
  - [Migration Content Creation](#migration-content-creation)
- [Flyway Execution Process](#flyway-execution-process)
  - [Automatic Migration Application](#automatic-migration-application)
  - [Schema History Tracking](#schema-history-tracking)
- [Migration Management](#migration-management)
  - [Preventing Duplicate Execution](#preventing-duplicate-execution)
  - [Database Reproducibility](#database-reproducibility)
- [Key Points](#key-points)
- [Links/References](#linksreferences)

## Database Versioning Overview

- **Real-world challenge**: Visual design great for learning but impractical for production workflows
- **Environment consistency**: Need identical database structure across testing, production, and team machines
- **Version control**: Database schema must be tracked and versioned like application code
- **Reproducibility**: Any team member should be able to recreate exact database structure

![Database Versioning Challenge](assets/database-versioning-challenge-diagram.png)

**Environment scenarios:**
- Development environments
- Testing/staging environments
- Production deployments
- New team member setups

## The Problem with Visual Design

- **Learning value**: Visual tools excellent for understanding database concepts
- **Production limitations**: Cannot easily reproduce database across environments
- **Team collaboration**: Difficult to share schema changes with team members
- **Version tracking**: No automatic tracking of schema evolution over time

![Visual Design Limitations](assets/visual-design-limitations-diagram.png)

**Workflow challenges:**
- Manual table creation on each environment
- No change history tracking
- Difficulty in rollback scenarios
- Team synchronization problems

## Introduction to Flyway

- **Popular migration tool**: Industry-standard database versioning solution
- **Script-based approach**: Database schema defined in SQL scripts
- **Automatic execution**: Applies migrations automatically on application startup
- **Change tracking**: Maintains history of all applied database changes

![Flyway Migration Workflow](assets/flyway-migration-workflow-diagram.png)

**Flyway benefits:**
- Database version control
- Consistent environments
- Automated deployment
- Change history tracking

## Setting Up Flyway

### Adding Flyway Dependencies

- **POM file access**: Use `Shift + Command + O` (Mac) or `Shift + Ctrl + O` (Windows)
- **Add Starters**: Click "Add Starters" button in POM file
- **Flyway search**: Search for "flyway" in dependency selector

![Flyway Dependency Search](assets/flyway-dependency-search.png)

```xml
<!-- Dependencies added automatically -->
<dependency>
    <groupId>org.flywaydb</groupId>
    <artifactId>flyway-core</artifactId>
</dependency>

<dependency>
    <groupId>org.flywaydb</groupId>
    <artifactId>flyway-mysql</artifactId>
</dependency>
```

![Flyway Dependencies Added](assets/flyway-dependencies-added-pom.png)

**Dependencies explained:**
- **flyway-core**: Core Flyway functionality
- **flyway-mysql**: MySQL-specific Flyway integration
- **Ownership**: Both dependencies owned by `org.flywaydb`

### Creating Migration Directory Structure

- **Location**: `src/main/resources` directory
- **Directory creation**: Create `db` folder, then `migration` subfolder
- **Case sensitivity**: Folder names must be exact for Flyway discovery
- **Standard structure**: Follows Spring Boot conventions

![Migration Directory Structure](assets/migration-directory-structure.png)

**Directory path:**
```
src/main/resources/
└── db/
    └── migration/
        └── [migration files go here]
```

**Important notes:**
- Spelling must be exact: `migration` not `migrations`
- Flyway automatically scans this location
- Structure required for automatic discovery

## Migration File Conventions

### Naming Convention Rules

- **Version prefix**: Start with capital `V` (for Version)
- **Version number**: Sequential number (1, 2, 3, etc.)
- **Separator**: Double underscores `__` between version and description
- **Description**: Descriptive name with single underscores allowed
- **File extension**: `.sql` for SQL migration files

![Flyway Naming Convention](assets/flyway-naming-convention-diagram.png)

**Naming pattern:**
```
V[VERSION]__[DESCRIPTION].sql

Examples:
V1__initial_migration.sql
V2__add_user_table.sql
V3__create_product_schema.sql
```

### Creating Migration Files

- **First migration**: `V1__initial_migration.sql`
- **Convention adherence**: Follow exact naming pattern
- **File creation**: Create in `db/migration` directory
- **Content**: SQL DDL statements for schema creation

![Migration File Creation](assets/migration-file-creation.png)

**Critical naming elements:**
- Capital `V` prefix
- Sequential version numbers
- Exactly two underscores `__`
- Descriptive but concise names

## Generating Migration Scripts

### SQL Script Generation

- **IntelliJ feature**: Right-click database → SQL Scripts → SQL Generator
- **Script options**: Various configuration options available on left side
- **Preview available**: Right side shows generated SQL statements
- **Export options**: Save to file or copy to clipboard

![SQL Script Generator Interface](assets/sql-script-generator-interface.png)

**Generation process:**
1. Right-click on database schema
2. Select "SQL Scripts" → "SQL Generator"
3. Review options and preview
4. Copy generated SQL to clipboard

### Migration Content Creation

```sql
-- V1__initial_migration.sql content
CREATE TABLE users (
    id BIGINT NOT NULL AUTO_INCREMENT,
    name VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL,
    password VARCHAR(255) NOT NULL,
    PRIMARY KEY (id)
);

CREATE TABLE addresses (
    id BIGINT NOT NULL AUTO_INCREMENT,
    street VARCHAR(255) NOT NULL,
    city VARCHAR(255) NOT NULL,
    zip VARCHAR(255) NOT NULL,
    user_id BIGINT NOT NULL,
    PRIMARY KEY (id),
    CONSTRAINT fk_addresses_user_id FOREIGN KEY (user_id) REFERENCES users (id)
);
```

![Migration File Content](assets/migration-file-content.png)

**Script components:**
- CREATE TABLE statements for all tables
- Primary key definitions
- Foreign key constraints
- Column specifications and constraints

## Flyway Execution Process

### Automatic Migration Application

- **Startup execution**: Flyway runs automatically when application starts
- **Migration discovery**: Scans `db/migration` directory for new migrations
- **Sequential application**: Applies migrations in version order
- **Database creation**: Can create database if it doesn't exist

![Flyway Automatic Execution](assets/flyway-automatic-execution-process.png)

**Execution demonstration:**
- Delete existing database to test
- Run application with migration files
- Flyway automatically creates tables

### Schema History Tracking

- **flyway_schema_history table**: Automatically created by Flyway
- **Migration tracking**: Records all applied migrations
- **Metadata storage**: Version, description, checksum, execution details
- **Duplicate prevention**: Prevents re-running applied migrations

![Flyway Schema History Table](assets/flyway-schema-history-table.png)

**History table contents:**
- **version**: Migration version number
- **description**: Migration description from filename
- **script**: Migration filename
- **checksum**: File integrity verification
- **execution_time**: How long migration took
- **success**: Whether migration completed successfully

![Schema History Table Data](assets/schema-history-table-data.png)

## Migration Management

### Preventing Duplicate Execution

- **History check**: Flyway checks `flyway_schema_history` before running migrations
- **Already applied**: Skips migrations that have been executed
- **Checksum validation**: Detects if migration files have been modified
- **Integrity protection**: Prevents accidental database corruption

![Migration Duplicate Prevention](assets/migration-duplicate-prevention.png)

**Safety mechanisms:**
- Version tracking prevents re-execution
- Checksum validation detects file changes
- Error reporting for corrupted migrations
- Safe re-run capabilities

### Database Reproducibility

- **Project inclusion**: Migration files are part of version control
- **Team sharing**: Anyone with project access can reproduce database
- **Environment consistency**: Same structure across all environments
- **Deployment automation**: Automated database setup in CI/CD pipelines

![Database Reproducibility Benefits](assets/database-reproducibility-benefits.png)

**Reproducibility advantages:**
- New team members get instant database setup
- Production deployments include schema changes
- Testing environments match production exactly
- No manual database setup required

## Key Points

- **Main takeaway**: Flyway enables database version control by converting visual schema designs into scripted migrations that can be reproduced across environments
- **Production necessity**: While visual design tools are great for learning, real-world applications require scripted database migrations for consistency and reliability
- **Convention importance**: Flyway migration files must follow strict naming conventions (V[VERSION]__[DESCRIPTION].sql) for automatic discovery and execution
- **Automatic execution**: Flyway automatically applies pending migrations on application startup, making database updates seamless
- **History tracking**: flyway_schema_history table prevents duplicate migration execution and provides audit trail of all database changes
- **Team collaboration**: Including migration files in version control ensures all team members can reproduce identical database structures
- **Environment consistency**: Same migration scripts work across development, testing, and production environments
- **Checksum validation**: Flyway detects accidental modification of applied migrations to maintain database integrity
- **SQL generation**: IntelliJ's SQL Generator provides easy way to convert visual designs into migration scripts
- **Zero-downtime benefits**: Proper migration management enables safe database updates without manual intervention

## Links/References

- Video: 4.6.2-Database-Migrations-with-Flyway.mp4 (04:52)
- Tool: [Flyway Official Documentation](https://flywaydb.org/documentation/)
- Previous: [Creating Database Tables](4.6.1-Creating-Database-Tables.md)
- Next: Schema Migration Best Practices

---

**Created**: July 31, 2025  
**Last Modified**: July 31, 2025
