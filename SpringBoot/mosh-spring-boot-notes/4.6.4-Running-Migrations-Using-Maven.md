# Running Migrations Using Maven

<!-- omit from toc -->

## Table of Contents

- [Maven Migration Overview](#maven-migration-overview)
- [Setting Up Flyway Maven Plugin](#setting-up-flyway-maven-plugin)
  - [Adding the Plugin](#adding-the-plugin)
  - [Plugin Configuration](#plugin-configuration)
  - [Database Connection Setup](#database-connection-setup)
- [Using Maven Tool Window](#using-maven-tool-window)
  - [Accessing Flyway Commands](#accessing-flyway-commands)
  - [Available Commands Overview](#available-commands-overview)
- [Essential Flyway Commands](#essential-flyway-commands)
  - [Migrate Command](#migrate-command)
  - [Info Command](#info-command)
  - [Clean Command](#clean-command)
  - [Validate Command](#validate-command)
  - [Repair Command](#repair-command)
- [Command Demonstrations](#command-demonstrations)
  - [Database Migration Execution](#database-migration-execution)
  - [Migration Information Display](#migration-information-display)
  - [Database Cleanup Operations](#database-cleanup-operations)
- [Migration Validation and Recovery](#migration-validation-and-recovery)
  - [Detecting Missing Migrations](#detecting-missing-migrations)
  - [Recovery Options](#recovery-options)
  - [File Restoration Process](#file-restoration-process)
- [Key Points](#key-points)
- [Links/References](#linksreferences)

## Maven Migration Overview

- **Alternative execution**: Run migrations without starting the application
- **Maven integration**: Use Flyway Maven plugin for database operations
- **Independent operation**: Execute migrations separately from application lifecycle
- **Development efficiency**: Faster migration testing and execution

![Maven Migration Workflow](assets/maven-migration-workflow.png)

**Benefits of Maven approach:**
- No application startup required
- Faster migration execution
- Independent database operations
- Better CI/CD integration

## Setting Up Flyway Maven Plugin

### Adding the Plugin

- **POM file access**: Navigate to project's pom.xml file
- **Plugin section**: Add to existing `<plugins>` element
- **Template generation**: Use IntelliJ's generate context menu

![POM File Plugin Section](assets/pom-file-plugin-section.png)

**Plugin addition steps:**
1. Open pom.xml file
2. Locate `<plugins>` section
3. Use `Cmd + N` (Mac) or `Ctrl + N` (Windows)
4. Select "Plugin Template" from context menu

![Plugin Template Generation](assets/plugin-template-generation.png)

```xml
<!-- Flyway Maven Plugin Configuration -->
<plugin>
    <groupId>org.flywaydb</groupId>
    <artifactId>flyway-maven-plugin</artifactId>
    <version>10.15.0</version>
    <configuration>
        <url>jdbc:mysql://localhost:3306/store?createDatabaseIfNotExist=true</url>
        <user>root</user>
        <password>your_mysql_password</password>
        <cleanDisabled>false</cleanDisabled>
    </configuration>
</plugin>
```

### Plugin Configuration

- **Artifact ID**: `flyway-maven-plugin`
- **Group ID**: `org.flywaydb` (use Ctrl+Space for autocomplete)
- **Version**: Latest available version (10.15.0 at time of recording)
- **Maven reload**: Required to download plugin

![Flyway Plugin Configuration](assets/flyway-plugin-configuration.png)

**Configuration requirements:**
- Specify correct group ID and artifact ID
- Use latest stable version
- Reload Maven project after adding plugin

### Database Connection Setup

- **Configuration element**: Add database connection details
- **URL source**: Copy from application.yaml file
- **Connection parameters**: URL, username, and password

![Database Configuration Copy](assets/database-configuration-copy.png)

**Configuration properties:**
- **URL**: Database connection string from application.yaml
- **User**: Database username (typically `root` for development)
- **Password**: Database password from MySQL setup

```yaml
# Source configuration from application.yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/store?createDatabaseIfNotExist=true
    username: root
    password: your_mysql_password
```

## Using Maven Tool Window

### Accessing Flyway Commands

- **Maven tool window**: Located on right side of IntelliJ
- **Project expansion**: Expand project node to see plugins
- **Plugin discovery**: Flyway plugin appears after Maven reload

![Maven Tool Window Flyway Plugin](assets/maven-tool-window-flyway-plugin.png)

**Navigation steps:**
1. Open Maven tool window (right side)
2. Expand project node
3. Expand "Plugins" node
4. Locate "flyway" plugin

### Available Commands Overview

- **migrate**: Apply pending migrations to database
- **clean**: Delete all database objects
- **info**: Display migration status and history
- **validate**: Check migration file integrity
- **repair**: Fix migration history inconsistencies

![Flyway Commands List](assets/flyway-commands-list.png)

**Command categories:**
- **Execution**: migrate, clean
- **Information**: info, validate
- **Maintenance**: repair, baseline

## Essential Flyway Commands

### Migrate Command

- **Primary function**: Apply all pending migrations to database
- **Automatic detection**: Discovers new migration files
- **Sequential execution**: Applies migrations in version order
- **Safe execution**: Only runs unapplied migrations

![Migrate Command Execution](assets/migrate-command-execution.png)

**Migrate process:**
1. Double-click "migrate" in Maven tool window
2. Flyway scans migration directory
3. Applies new migrations sequentially
4. Updates migration history table

### Info Command

- **Migration status**: Shows all migrations and their status
- **History display**: Equivalent to viewing flyway_schema_history table
- **Current state**: Shows what's been applied and what's pending

![Info Command Output](assets/info-command-output.png)

**Info command benefits:**
- View migration history without database access
- Check current migration status
- Identify pending migrations
- Troubleshoot migration issues

### Clean Command

- **Database reset**: Removes all database objects
- **Default disabled**: Safety feature prevents accidental data loss
- **Configuration required**: Must enable with `cleanDisabled=false`
- **Development use**: Useful for fresh database starts

![Clean Command Configuration](assets/clean-command-configuration.png)

**Clean command setup:**
```xml
<configuration>
    <!-- Other configuration -->
    <cleanDisabled>false</cleanDisabled>
</configuration>
```

**Clean command error handling:**
- Default error when cleanDisabled is true
- Clear error message explains requirement
- Safety mechanism prevents accidental data loss

![Clean Command Error](assets/clean-command-error.png)

### Validate Command

- **Integrity check**: Verifies all applied migrations still exist
- **File validation**: Ensures migration files haven't been corrupted
- **Error detection**: Identifies missing or modified migration files

![Validate Command Process](assets/validate-command-process.png)

### Repair Command

- **History repair**: Fixes migration history inconsistencies
- **Intentional deletion**: Marks migrations as intentionally removed
- **Recovery tool**: Helps recover from migration mistakes
- **Team coordination**: Use only when migrations haven't been shared

![Repair Command Usage](assets/repair-command-usage.png)

## Command Demonstrations

### Database Migration Execution

- **Database deletion**: Remove existing database for demonstration
- **Clean slate**: Start with fresh database environment
- **Migration execution**: Run migrate command to create all tables

![Database Deletion Demo](assets/database-deletion-demo.png)

**Demonstration steps:**
1. Delete database from database window
2. Refresh to confirm table removal
3. Run migrate command from Maven tool window
4. Verify table creation in database window

![Migration Execution Result](assets/migration-execution-result.png)

### Migration Information Display

- **Info command execution**: Display current migration status
- **History overview**: Shows all three applied migrations
- **Status verification**: Confirms successful migration application

![Migration Info Display](assets/migration-info-display.png)

### Database Cleanup Operations

- **Clean command execution**: Remove all database objects
- **Configuration requirement**: Enable clean functionality first
- **Complete reset**: All tables and data removed
- **Re-migration**: Run migrate again to recreate schema

![Database Clean Operation](assets/database-clean-operation.png)

## Migration Validation and Recovery

### Detecting Missing Migrations

- **Validation scenario**: Accidentally deleted migration file
- **Error detection**: Validate command identifies missing file
- **Clear error message**: Shows which migration is missing

![Missing Migration Detection](assets/missing-migration-detection.png)

**Validation error example:**
- Delete V2 migration file accidentally
- Run validate command
- Flyway detects missing migration #2
- Clear error message shows the problem

### Recovery Options

- **Two recovery paths**: Repair or restore file
- **Repair option**: Mark migration as intentionally deleted
- **File restoration**: Recover accidentally deleted file
- **Team considerations**: Only repair if not shared with team

![Migration Recovery Options](assets/migration-recovery-options.png)

**Recovery decision factors:**
- Whether migration was shared with team
- Whether committed to Git repository
- Intentional vs accidental deletion
- Current development stage

### File Restoration Process

- **Git recovery**: Use version control to restore file
- **Commit window**: Access through IntelliJ's Git interface
- **File restoration**: Bring back accidentally deleted migration
- **Validation success**: Confirm recovery with validate command

![File Restoration Process](assets/file-restoration-process.png)

**Restoration steps:**
1. Open Git commit window
2. Locate deleted migration file
3. Restore file from version control
4. Run validate to confirm fix

## Key Points

- **Main takeaway**: Flyway Maven plugin provides independent migration execution without requiring application startup, improving development efficiency
- **Plugin integration**: Simple setup through pom.xml with database configuration copied from application.yaml for consistency
- **Command variety**: Essential commands include migrate (apply), info (status), clean (reset), validate (check), and repair (fix) for comprehensive migration management
- **Safety features**: Clean command disabled by default prevents accidental data loss, requiring explicit configuration to enable
- **Validation protection**: Validate command detects missing or corrupted migration files to maintain database integrity
- **Recovery mechanisms**: Repair command helps recover from migration mistakes, but should only be used when migrations haven't been shared with team
- **Development workflow**: Maven approach enables faster iteration cycles by separating migration execution from application development
- **Error handling**: Clear error messages and recovery options help developers resolve migration issues efficiently
- **Team coordination**: Understanding when to use repair vs file restoration is crucial for team collaboration
- **CI/CD integration**: Maven plugin approach better suited for automated deployment pipelines than application-based migrations

## Links/References

- Video: 4.6.4-Running-Migrations-Using-Maven.mp4 (05:17)
- Plugin: [Flyway Maven Plugin Documentation](https://flywaydb.org/documentation/usage/maven/)
- Previous: [Changing the Database Schema](4.6.3-Changing-the-Database-Schema.md)
- Next: Database Migration Exercise

---

**Created**: July 31, 2025  
**Last Modified**: July 31, 2025
