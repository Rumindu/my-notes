# Model-First with JPA Buddy

<!-- omit from toc -->

## Table of Contents

- [Model-First Approach Overview](#model-first-approach-overview)
- [Adding New Field to Entity](#adding-new-field-to-entity)
- [JPA Buddy Warning and Actions](#jpa-buddy-warning-and-actions)
- [Migration Dialog Configuration](#migration-dialog-configuration)
- [Understanding Change Summary](#understanding-change-summary)
- [Customizing Column Attributes](#customizing-column-attributes)
- [Column Definition Options](#column-definition-options)
- [Nullable Constraints](#nullable-constraints)
- [Database-First vs Model-First](#database-first-vs-model-first)
- [Managing Unwanted Changes](#managing-unwanted-changes)
- [Creating and Running Migration](#creating-and-running-migration)
- [Alternative Migration Creation](#alternative-migration-creation)
- [Key Points](#key-points)
- [Links/References](#linksreferences)

## Model-First Approach Overview

- **Approach definition**: Start with domain model changes, then generate database migrations
- **JPA Buddy integration**: IntelliJ plugin helps generate Flyway migrations from model changes
- **Change detection**: Tool compares current model state with database state
- **Migration generation**: Automatically creates SQL scripts for database updates

![Model-First Approach Workflow](assets/model-first-approach-workflow.png)

**Model-first workflow:**
1. Modify entity classes in code
2. JPA Buddy detects model-database differences
3. Generate Flyway migration script
4. Run migration to update database
5. Database schema matches model

## Adding New Field to Entity

- **Field addition**: Add new field to existing Product entity
- **Column annotation**: Apply @Column annotation with name attribute
- **JPA Buddy detection**: Plugin immediately detects model-database mismatch
- **Warning indication**: Visual warning appears for unmapped column

```java
@Entity
@Table(name = "products")
public class Product {
    // Existing fields...
    
    @Column(name = "description")
    private String description;
    
    // Other methods...
}
```

![Adding Description Field to Product Entity](assets/adding-description-field-product-entity.png)

**Implementation steps:**
1. Add private String description field
2. Apply @Column(name = "description") annotation
3. JPA Buddy shows warning for unresolved column
4. Warning indicates column doesn't exist in database

## JPA Buddy Warning and Actions

- **Warning message**: "Cannot resolve column description"
- **Hover information**: Shows column doesn't exist in database
- **Action menu**: Alt + Enter brings up available actions
- **Migration option**: "Create Flyway migration" option available

![JPA Buddy Column Warning](assets/jpa-buddy-column-warning.png)

**Available actions:**
- **Assign different data source**: Use different database schema
- **Create Flyway migration**: Generate migration script for changes
- **Ignore warning**: Suppress warning without action
- **Quick fix options**: Context-sensitive solutions

![JPA Buddy Action Menu](assets/jpa-buddy-action-menu.png)

## Migration Dialog Configuration

- **Source selection**: Choose between Model or Database as source
- **Target selection**: Choose between Database or Snapshot as target
- **Model-first setup**: Source = Model, Target = Database
- **Scope selection**: Choose which entities to include in comparison

![Migration Dialog Configuration](assets/migration-dialog-configuration.png)

**Configuration options:**
- **Source (left side)**: Model (represents latest state with changes)
- **Target (right side)**: Database (represents current database state)
- **Scope**: Selected entities (1 of 8 entities shown)
- **Database connection**: Verify correct connection selected

![Migration Source Target Selection](assets/migration-source-target-selection.png)

**Scope management:**
- **Entity selection**: Click scope to see all available entities
- **Multiple changes**: Select multiple entities if changes span across them
- **Current selection**: Only Product entity selected for this example

## Understanding Change Summary

- **Change overview**: Dialog shows all detected differences
- **Color coding**: Green (safe), Red (dangerous), Yellow (caution)
- **Multiple changes**: More changes than expected due to previous modifications
- **Change types**: Add column, drop table, modify constraints

![Change Summary Dialog](assets/change-summary-dialog.png)

**Change categories:**
- **Green changes**: Safe operations (add column)
- **Red changes**: Dangerous operations (drop table)
- **Yellow changes**: Operations requiring caution (modify constraints)
- **Expected change**: Add description column to products table

**Dangerous changes example:**
- **Drop user_tags table**: Potentially destructive operation
- **Reason**: Previous model modifications not reflected in database
- **Caution required**: Review all red changes carefully

![Dangerous Changes Warning](assets/dangerous-changes-warning.png)

## Customizing Column Attributes

- **Default type**: VARCHAR(255) assigned by default
- **Length customization**: Modify length attribute for different size
- **Regeneration required**: Cancel and modify entity, then regenerate migration
- **Attribute flexibility**: Various column attributes can be customized

**Length modification example:**
```java
@Column(name = "description", length = 1000)
private String description;
```

![Column Length Customization](assets/column-length-customization.png)

**Updated migration result:**
- **Column type**: Changes from VARCHAR(255) to VARCHAR(1000)
- **Regeneration**: Must cancel dialog and regenerate after entity modification
- **Flexibility**: Allows precise control over column specifications

## Column Definition Options

- **Column definition**: Use columnDefinition for specific SQL types
- **Text type**: Specify TEXT instead of VARCHAR for large content
- **SQL flexibility**: Direct SQL type specification available
- **Database-specific**: Can use database-specific column types

```java
@Column(name = "description", columnDefinition = "TEXT")
private String description;
```

![Column Definition Text Type](assets/column-definition-text-type.png)

**Column definition benefits:**
- **SQL type control**: Direct specification of database column type
- **Large content**: TEXT type for unlimited content length
- **Database optimization**: Choose optimal type for data requirements
- **Migration reflection**: SQL script reflects specified column definition

## Nullable Constraints

- **Default nullable**: Columns are nullable by default
- **Constraint modification**: Add nullable = false for required fields
- **Two-step process**: Add column as nullable, then modify to not nullable
- **Migration safety**: Prevents data issues during migration

```java
@Column(name = "description", columnDefinition = "TEXT", nullable = false)
private String description;
```

![Nullable Constraint Configuration](assets/nullable-constraint-configuration.png)

**Two-step migration process:**
1. **Add column**: CREATE column as nullable (allows existing rows)
2. **Modify constraint**: ALTER column to NOT NULL (after column exists)

**Migration safety benefits:**
- **Existing data**: Prevents constraint violations on existing rows
- **Gradual change**: Allows data population before constraint enforcement
- **Rollback safety**: Each step can be individually managed

![Two-Step Migration Process](assets/two-step-migration-process.png)

## Database-First vs Model-First

- **Database-first approach**: Cleaner entities with minimal annotations
- **Model-first approach**: Entities contain detailed database specifications
- **Entity complexity**: Model-first results in more cluttered entity classes
- **Responsibility shift**: Entities become responsible for database behavior

![Database-First vs Model-First Comparison](assets/database-first-vs-model-first-comparison.png)

**Database-first characteristics:**
- **Clean entities**: Only essential JPA annotations
- **Separate concerns**: Database schema defined in migration scripts
- **Minimal coupling**: Entities focus on business logic
- **Migration-driven**: Schema changes through dedicated migration files

**Model-first characteristics:**
- **Detailed annotations**: Entities contain database specifications
- **Mixed responsibility**: Entities define both structure and database behavior
- **Cluttered code**: More annotations required in entity classes
- **Model-driven**: Schema changes through entity modifications

## Managing Unwanted Changes

- **Change filtering**: Select and remove unwanted changes from migration
- **Remove options**: "Remove from changelog" or "Remove and ignore"
- **Ignore list**: "Remove and ignore" prevents future inclusion
- **Selective migration**: Include only desired changes in migration script

![Managing Unwanted Changes](assets/managing-unwanted-changes.png)

**Change management options:**
- **Remove from changelog**: Exclude from current migration only
- **Remove and ignore**: Exclude from current and future migrations
- **Ignore benefits**: Prevents recurring unwanted changes
- **Clean migrations**: Focus on intended database changes only

**Example unwanted changes:**
- **Price column modifications**: Type changes from previous lessons
- **Constraint modifications**: Nullable changes from earlier modifications
- **Table drops**: Potentially destructive operations to review

![Unwanted Changes Selection](assets/unwanted-changes-selection.png)

## Creating and Running Migration

- **Migration naming**: Set descriptive name for migration file
- **File generation**: Creates SQL file in migration directory
- **Maven execution**: Use Flyway Maven plugin to run migration
- **Database verification**: Confirm changes applied successfully

![Migration File Creation](assets/migration-file-creation.png)

**Migration creation steps:**
1. **Name migration**: Set descriptive name (e.g., "add description")
2. **Generate file**: Creates V7__add_description.sql
3. **Review SQL**: Examine generated migration script
4. **Execute migration**: Run flyway:migrate Maven goal

```bash
# Maven command for migration
mvn flyway:migrate
```

![Maven Flyway Migration Execution](assets/maven-flyway-migration-execution.png)

**Database verification:**
- **Database window**: Check products table structure
- **Column presence**: Verify description column exists
- **Table refresh**: Refresh database view to see changes

![Database Column Verification](assets/database-column-verification.png)

## Alternative Migration Creation

- **Right-click method**: Alternative way to create migrations
- **Migration directory**: Right-click on migration folder
- **New Flyway migration**: Direct menu option available
- **All entities scope**: Default scope includes all entities

![Alternative Migration Creation Method](assets/alternative-migration-creation-method.png)

**Alternative workflow:**
1. Right-click migration directory
2. Select "New" → "Flyway Migration"
3. Same dialog appears with full scope
4. Useful for multiple entity changes

**Scope differences:**
- **Warning method**: Single entity scope (affected entity)
- **Directory method**: All entities scope (comprehensive comparison)
- **Use case**: Directory method better for multiple changes across entities

## Key Points

- **Main takeaway**: Model-first approach with JPA Buddy allows generating Flyway migrations from entity changes, but requires detailed database annotations in entity classes
- **Approach consistency**: Choose either database-first or model-first approach and stick with it throughout project to avoid complexity and conflicts
- **Change management**: JPA Buddy detects all model-database differences, requiring careful review to include only intended changes in migrations
- **Entity complexity**: Model-first approach makes entities responsible for both business logic and database schema definition, resulting in more cluttered code
- **Color-coded safety**: Migration dialog uses green (safe), yellow (caution), and red (dangerous) color coding to help identify change impact levels
- **Two-step constraints**: Adding NOT NULL constraints follows two-step process (add nullable column, then modify constraint) to prevent data integrity issues
- **Column customization**: Entity annotations like length, columnDefinition, and nullable directly influence generated SQL migration scripts
- **Change filtering**: Unwanted changes can be removed from migrations and added to ignore list to prevent future inclusion
- **Verification workflow**: Always verify database changes by checking actual table structure after running migrations
- **Alternative access**: Multiple ways to access migration creation (entity warnings, directory right-click) provide workflow flexibility

## Links/References

- Video: 4.7.9-Model-First-with-JPA-Buddy.mp4 (07:39)
- Previous: Database Schema Versioning Concepts
- Next: Advanced JPA Relationships
- Tool: [JPA Buddy Plugin](https://plugins.jetbrains.com/plugin/15075-jpa-buddy) (IntelliJ plugin)
- Reference: [Flyway Maven Plugin](https://flywaydb.org/documentation/usage/maven/)

---

**Created**: July 31, 2025  
**Last Modified**: July 31, 2025
