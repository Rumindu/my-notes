# Understanding Entity States

<!-- omit from toc -->

## Table of Contents

- [Table of Contents](#table-of-contents)
- [Entity States Overview](#entity-states-overview)
- [Transient State](#transient-state)
- [Persistence Context](#persistence-context)
- [Persistent State](#persistent-state)
- [Detached State](#detached-state)
- [Remove State](#remove-state)
- [Entity Lifecycle](#entity-lifecycle)
- [Transaction Connection](#transaction-connection)
- [Key Points](#key-points)
- [Links/References](#linksreferences)

## Entity States Overview

- **Foundation knowledge**: Understanding entity states crucial for debugging database issues
- **Repository abstraction**: Repositories hide complexity but understanding internals remains important
- **State transitions**: Entities move through different states during their lifecycle
- **Hibernate management**: Different states determine how Hibernate tracks and manages entities

![Entity States Overview Diagram](assets/entity-states-overview-diagram.png)

**Four main entity states:**
- **Transient**: Newly created entity not yet managed by Hibernate
- **Persistent**: Entity managed by Hibernate and tracked in persistence context
- **Detached**: Previously persistent entity no longer managed by Hibernate
- **Remove**: Entity marked for deletion from database

## Transient State

- **Initial state**: Entity enters transient state when created with `new` keyword
- **Meaning**: "Transient" means temporary - entity exists only in memory
- **No tracking**: Hibernate doesn't know about or manage transient entities
- **No database connection**: Entity has no database identifier or persistence

```java
// Entity starts in transient state
var user = new User();
user.setName("John");
user.setEmail("john@example.com");
// user is currently TRANSIENT
```

![Transient Entity State Example](assets/transient-entity-state-example.png)

**Transient characteristics:**
- **Memory only**: Exists solely in application memory
- **No ID**: Has no database identifier assigned
- **Unmanaged**: Changes not tracked by Hibernate
- **Temporary**: Will be garbage collected if not persisted

## Persistence Context

- **Working memory**: Persistence context serves as Hibernate's working memory
- **Entity container**: Contains objects that should be tracked and managed
- **Similar concept**: Like application context for beans, but for persistent entities
- **Management scope**: Defines which entities Hibernate actively monitors

![Persistence Context Container Diagram](assets/persistence-context-container-diagram.png)

**Persistence context characteristics:**
- **Entity tracking**: Monitors changes to persistent entities
- **Memory management**: Maintains entities during transaction lifetime
- **Change detection**: Automatically detects modifications to tracked entities
- **Synchronization**: Coordinates entity state with database

## Persistent State

- **State transition**: Entity becomes persistent when `repository.save()` is called
- **Context entry**: Entity gets added to persistence context container
- **Database persistence**: Hibernate saves entity to database
- **ID assignment**: Database assigns primary key, Hibernate stores it in entity

```java
// Transition from transient to persistent
var user = new User();  // TRANSIENT
user.setName("John");

repository.save(user);  // Now PERSISTENT
// user.getId() now contains database-assigned ID
```

![Persistent State Transition](assets/persistent-state-transition.png)

**Persistent state features:**
- **Change tracking**: Hibernate monitors all property modifications
- **Automatic synchronization**: Changes automatically saved to database
- **Identity management**: Entity has valid database identifier
- **Context managed**: Fully managed by persistence context

## Detached State

- **Context lifetime**: Persistence context has limited lifetime, eventually gets cleared
- **State transition**: When context clears, persistent entities become detached
- **Management loss**: Detached entities no longer tracked by Hibernate
- **Identity retention**: Unlike transient entities, detached entities have database identifiers

![Detached Entity State Diagram](assets/detached-entity-state-diagram.png)

**Detached vs Transient differences:**
- **Database ID**: Detached entities have valid database identifiers
- **Previous persistence**: Detached entities were persistent before
- **No tracking**: Neither transient nor detached entities are tracked
- **Reattachment**: Detached entities can be reattached to new persistence context

**Working with detached entities:**
```java
// Entity becomes detached when persistence context closes
// Making changes to detached entity
detachedUser.setEmail("newemail@example.com");

// Calling save reattaches entity to new persistence context
repository.save(detachedUser);  // DETACHED → PERSISTENT
// Changes are now persisted to database
```

![Detached Entity Reattachment](assets/detached-entity-reattachment.png)

## Remove State

- **Deletion process**: When deleting persistent entity, it transitions to remove state
- **Database operation**: Hibernate deletes entity from database
- **Final transition**: After deletion, entity becomes transient again
- **Lifecycle completion**: Entity returns to initial state after removal

```java
var user = repository.findById(1L).get();  // PERSISTENT
repository.delete(user);  // PERSISTENT → REMOVE → TRANSIENT
// Entity deleted from database and becomes transient
```

![Remove State Transition Process](assets/remove-state-transition-process.png)

**Remove state characteristics:**
- **Temporary state**: Brief transition state during deletion
- **Database cleanup**: Entity removed from database during this state
- **Context removal**: Entity removed from persistence context
- **Memory cleanup**: Entity can be garbage collected after removal

## Entity Lifecycle

- **Complete cycle**: Entities move through states based on operations performed
- **State management**: Each state has specific characteristics and behaviors
- **Hibernate control**: Framework manages state transitions automatically
- **Developer awareness**: Understanding states helps with debugging and optimization

![Complete Entity Lifecycle Diagram](assets/complete-entity-lifecycle-diagram.png)

**Lifecycle flow patterns:**
```java
// Full lifecycle example
var user = new User();           // TRANSIENT
repository.save(user);           // TRANSIENT → PERSISTENT
// ... persistence context closes
// user is now DETACHED
repository.save(user);           // DETACHED → PERSISTENT
repository.delete(user);         // PERSISTENT → REMOVE → TRANSIENT
```

![Entity Lifecycle Flow Example](assets/entity-lifecycle-flow-example.png)

**State transition triggers:**
- **new operator**: Creates transient entity
- **save() method**: Moves transient/detached to persistent
- **context closure**: Moves persistent to detached
- **delete() method**: Moves persistent to remove to transient

## Transaction Connection

- **Context lifetime**: Persistence context lifetime tied to transaction scope
- **Transaction boundary**: When transaction ends, persistence context typically closes
- **State implications**: Understanding transactions crucial for entity state management
- **Future topic**: Detailed transaction concepts covered in next lesson

![Transaction and Persistence Context Relationship](assets/transaction-persistence-context-relationship.png)

**Transaction impact:**
- **Context scope**: Persistence context usually bound to transaction
- **Automatic management**: Spring manages transaction boundaries automatically
- **State changes**: Transaction completion often triggers entity state changes
- **Performance implications**: Understanding helps optimize database operations

## Key Points

- **Main takeaway**: Entity states represent different levels of Hibernate management, from unmanaged transient entities to tracked persistent entities
- **Transient entities**: Created with `new` keyword, exist only in memory, not tracked by Hibernate
- **Persistence context**: Hibernate's working memory container that tracks and manages persistent entities
- **Persistent entities**: Added to persistence context via `save()`, fully managed and automatically synchronized with database
- **Detached entities**: Previously persistent entities that lost Hibernate management when persistence context closed, but retain database identifiers
- **Remove state**: Temporary state during entity deletion before becoming transient again
- **State transitions**: Entities automatically move between states based on operations like `save()` and `delete()`
- **Database ID assignment**: Entities receive database identifiers when transitioning to persistent state
- **Context lifetime**: Persistence context has limited lifetime, typically tied to transaction boundaries
- **Debugging importance**: Understanding entity states crucial for troubleshooting database-related issues and performance optimization

## Links/References

- Video: 4.8.3-Understanding-Entity-States.mp4 (02:08)
- Previous: [Using Repositories](4.8.2-Using-Repositories.md)
- Next: Transactions and Entity Management
- Reference: [JPA Entity Lifecycle](https://docs.oracle.com/javaee/7/tutorial/persistence-intro003.htm)
- Reference: [Hibernate Entity States](https://docs.jboss.org/hibernate/orm/5.6/userguide/html_single/Hibernate_User_Guide.html#pc)

---

**Created**: July 31, 2025  
**Last Modified**: July 31, 2025
