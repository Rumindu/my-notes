# Persisting Related Entities

<!-- omit from toc -->

## Table of Contents

- [Table of Contents](#table-of-contents)
- [Persisting Related Entities Overview](#persisting-related-entities-overview)
- [Creating the Persist Method](#creating-the-persist-method)
- [Building User and Address Objects](#building-user-and-address-objects)
- [Adding Address to User](#adding-address-to-user)
- [Helper Method Review](#helper-method-review)
- [Initial Save Attempt](#initial-save-attempt)
- [Understanding Default Persistence Behavior](#understanding-default-persistence-behavior)
- [Manual Address Persistence](#manual-address-persistence)
- [Cascade Operations Introduction](#cascade-operations-introduction)
- [Cascade Types Overview](#cascade-types-overview)
- [Implementing Cascade Persist](#implementing-cascade-persist)
- [Testing Cascade Persistence](#testing-cascade-persistence)
- [Key Points](#key-points)
- [Links/References](#linksreferences)

## Persisting Related Entities Overview

- **Challenge**: Saving parent entity with related child entities
- **Default behavior**: Hibernate doesn't automatically persist related entities
- **Solutions**: Manual persistence or cascade operations
- **Use case**: User with associated addresses, orders with items, etc.

![Persisting Related Entities Overview](assets/persisting-related-entities-overview.png)

**Common scenarios:**
- **User with addresses**: Customer and delivery/billing addresses
- **Order with items**: Shopping cart persistence
- **Blog with comments**: Content management systems
- **Parent-child relationships**: Any hierarchical data structure

## Creating the Persist Method

- **Service method**: Add persistRelated method to UserService
- **Objective**: Save user and address entities together
- **Method structure**: Create objects, establish relationships, persist data
- **Testing approach**: Demonstrate different persistence strategies

```java
@Service
public class UserService {
    
    public void persistRelated() {
        // Method to demonstrate persisting related entities
    }
}
```

![Persist Related Method Creation](assets/persist-related-method-creation.png)

## Building User and Address Objects

- **Builder pattern usage**: Create user and address objects using builders
- **Property setting**: Configure essential fields for both entities
- **Object preparation**: Build complete objects before establishing relationships
- **Data consistency**: Ensure all required fields populated

```java
public void persistRelated() {
    // Create user object
    var user = User.builder()
        .name("John Doe")
        .email("john@example.com")
        .password("password123")
        .build();
    
    // Create address object
    var address = Address.builder()
        .street("123 Main St")
        .city("New York")
        .state("NY")
        .zip("10001")
        .build();
}
```

![User and Address Object Creation](assets/user-address-object-creation.png)

**Builder pattern benefits:**
- **Readable code**: Clear field assignments
- **Immutable objects**: Objects built in consistent state
- **Flexible construction**: Optional parameters easily handled
- **Type safety**: Compile-time validation of field types

## Adding Address to User

- **Relationship establishment**: Connect address to user using helper method
- **Helper method usage**: Call user.addAddress() to establish bidirectional relationship
- **Data integrity**: Ensure both sides of relationship properly set
- **Encapsulation**: Use helper methods rather than direct field manipulation

```java
// Establish relationship between user and address
user.addAddress(address);
```

![Address to User Relationship](assets/address-to-user-relationship.png)

## Helper Method Review

- **Method location**: addAddress method in User entity class
- **Dual operation**: Add address to user's list and set user on address
- **Bidirectional sync**: Ensure both sides of relationship updated
- **Implementation details**: Review previously created helper method

```java
// In User entity class
public void addAddress(Address address) {
    addresses.add(address);    // Add to user's address list
    address.setUser(this);     // Set user reference on address
}
```

![Helper Method Implementation Review](assets/helper-method-implementation-review.png)

**Helper method functionality:**
- **Collection management**: Add address to user's addresses list
- **Back-reference**: Set user property on address entity
- **Relationship integrity**: Maintain bidirectional relationship consistency
- **Encapsulation**: Hide relationship management complexity

## Initial Save Attempt

- **Single save operation**: Call userRepository.save() only
- **Expectation**: Both user and address should be persisted
- **Reality check**: Test actual behavior vs expected behavior
- **Result analysis**: Observe generated SQL statements

```java
// Save user (expecting address to be saved automatically)
userRepository.save(user);
```

![Initial Save Attempt Code](assets/initial-save-attempt-code.png)

**Execution and observation:**
```java
// In main method
var service = context.getBean(UserService.class);
service.persistRelated();
```

![Main Method Execution Call](assets/main-method-execution-call.png)

## Understanding Default Persistence Behavior

- **Single INSERT statement**: Only user record inserted into database
- **Missing address**: Address entity not automatically persisted
- **Default behavior**: Hibernate doesn't propagate persist operations by default
- **Explicit requirement**: Related entities must be explicitly saved

![Default Persistence Behavior Analysis](assets/default-persistence-behavior-analysis.png)

**Generated SQL (default behavior):**
```sql
INSERT INTO users (email, name, password) VALUES (?, ?, ?)
-- No INSERT statement for addresses table
```

![Single User Insert Statement](assets/single-user-insert-statement.png)

**Why address not saved:**
- **No cascade configuration**: Relationship lacks cascade settings
- **Explicit saves required**: Each entity needs separate save operation
- **Performance consideration**: Prevents unintended data persistence
- **Developer control**: Forces explicit decision about what to persist

## Manual Address Persistence

- **Two-step approach**: Save user first, then save address separately
- **Repository usage**: Use both userRepository and addressRepository
- **Explicit control**: Developer decides what gets persisted when
- **Multiple statements**: Results in separate INSERT statements

```java
public void persistRelated() {
    var user = User.builder()
        .name("John Doe")
        .email("john@example.com")
        .password("password123")
        .build();
    
    var address = Address.builder()
        .street("123 Main St")
        .city("New York")
        .state("NY")
        .zip("10001")
        .build();
    
    user.addAddress(address);
    
    // Manual persistence - two separate save operations
    userRepository.save(user);
    addressRepository.save(address);
}
```

![Manual Address Persistence Code](assets/manual-address-persistence-code.png)

**Generated SQL (manual approach):**
```sql
INSERT INTO users (email, name, password) VALUES (?, ?, ?)
INSERT INTO addresses (street, city, state, zip, user_id) VALUES (?, ?, ?, ?, ?)
```

![Manual Persistence SQL Statements](assets/manual-persistence-sql-statements.png)

**Manual approach characteristics:**
- **Explicit control**: Developer specifies exactly what to save
- **Multiple operations**: Requires multiple repository calls
- **Verbose code**: More lines of code for simple operations
- **Clear intent**: Obvious what operations are being performed

## Cascade Operations Introduction

- **Cleaner approach**: Alternative to manual persistence
- **Automatic propagation**: Related entities saved automatically
- **Cascade attribute**: Configuration option on relationship annotations
- **JPA feature**: Standard JPA functionality for relationship management

![Cascade Operations Introduction](assets/cascade-operations-introduction.png)

**Cascade concept:**
- **Operation propagation**: Parent operations affect child entities
- **Automatic handling**: Framework manages related entity persistence
- **Configuration-driven**: Behavior controlled by annotation attributes
- **Relationship-specific**: Applied to individual relationship mappings

## Cascade Types Overview

- **CascadeType enumeration**: Various cascade operation types available
- **Specific operations**: Each type handles different entity lifecycle events
- **Selective application**: Choose appropriate cascade types for use case
- **Avoid CascadeType.ALL**: Can lead to unexpected behavior

![Cascade Types Overview Diagram](assets/cascade-types-overview-diagram.png)

**Available cascade types:**
- **PERSIST**: Propagate persist operations (save new entities)
- **MERGE**: Propagate merge operations (update existing entities)
- **REMOVE**: Propagate remove operations (delete entities)
- **DETACH**: Propagate detach operations (remove from persistence context)
- **REFRESH**: Propagate refresh operations (reload from database)
- **ALL**: All of the above operations (use with caution)

![Cascade Types Enumeration](assets/cascade-types-enumeration.png)

**Cascade type usage guidelines:**
- **PERSIST**: Most common for parent-child relationships
- **MERGE**: Useful for updating related entities
- **REMOVE**: Careful consideration required (can delete important data)
- **DETACH/REFRESH**: Rarely used with Spring Data repositories
- **ALL**: Generally not recommended due to unpredictable side effects

## Implementing Cascade Persist

- **Annotation modification**: Add cascade attribute to @OneToMany annotation
- **CascadeType.PERSIST**: Specify persist operation propagation
- **User entity change**: Modify relationship annotation in User class
- **Automatic persistence**: Child entities saved when parent saved

```java
@Entity
public class User {
    
    @OneToMany(mappedBy = "user", cascade = CascadeType.PERSIST)
    private List<Address> addresses = new ArrayList<>();
    
    // Other fields and methods...
}
```

![Cascade Persist Implementation](assets/cascade-persist-implementation.png)

**Implementation details:**
- **Cascade attribute**: Added to existing @OneToMany annotation
- **CascadeType.PERSIST**: Specifically propagates save operations
- **Selective cascading**: Only persist operations cascaded, not all operations
- **Relationship preservation**: mappedBy and other attributes unchanged

## Testing Cascade Persistence

- **Remove manual save**: Remove addressRepository.save() call
- **Single save operation**: Only userRepository.save() needed
- **Automatic propagation**: Address automatically persisted with user
- **SQL verification**: Observe two INSERT statements generated

```java
public void persistRelated() {
    var user = User.builder()
        .name("John Doe")
        .email("john@example.com")
        .password("password123")
        .build();
    
    var address = Address.builder()
        .street("123 Main St")
        .city("New York")
        .state("NY")
        .zip("10001")
        .build();
    
    user.addAddress(address);
    
    // Single save operation with cascade
    userRepository.save(user);  // Address automatically saved
}
```

![Cascade Persistence Testing Code](assets/cascade-persistence-testing-code.png)

**Generated SQL (with cascade):**
```sql
INSERT INTO users (email, name, password) VALUES (?, ?, ?)
INSERT INTO addresses (street, city, state, zip, user_id) VALUES (?, ?, ?, ?, ?)
```

![Cascade Persistence SQL Output](assets/cascade-persistence-sql-output.png)

**Cascade persistence benefits:**
- **Simplified code**: Single save operation handles multiple entities
- **Automatic propagation**: Framework handles relationship persistence
- **Data consistency**: Related entities saved in same transaction
- **Cleaner API**: More intuitive parent-child persistence model

## Key Points

- **Main takeaway**: By default, Hibernate doesn't automatically persist related entities - explicit configuration or manual saves required
- **Cascade operations**: Use cascade = CascadeType.PERSIST to automatically save related entities when parent is saved
- **Manual alternative**: Can manually save each entity separately using multiple repository calls for explicit control
- **Helper methods**: Use relationship helper methods (like addAddress) to maintain bidirectional relationship integrity
- **Cascade types**: Choose specific cascade types (PERSIST, MERGE, REMOVE) rather than CascadeType.ALL to avoid unexpected behavior
- **Transaction safety**: Cascade operations occur within same transaction, ensuring data consistency
- **Code simplification**: Cascade persistence reduces boilerplate code and makes parent-child relationships more intuitive
- **Builder pattern**: Use builder pattern for clean, readable object creation with complex entities
- **SQL generation**: Both manual and cascade approaches generate appropriate INSERT statements for all entities
- **Performance consideration**: Cascade operations can impact performance with large object graphs, so use judiciously

## Links/References

- Video: 4.8.7-Persisting-Related-Entities.mp4 (03:17)
- Previous: [Exercise: Understanding Fetching Strategies](4.8.6-Exercise-Understanding-Fetching-Strategies.md)
- Next: Deleting Related Entities
- Reference: [JPA Cascade Types](https://docs.oracle.com/javaee/7/api/javax/persistence/CascadeType.html)
- Reference: [Hibernate Cascading](https://docs.jboss.org/hibernate/orm/5.6/userguide/html_single/Hibernate_User_Guide.html#pc-cascade)

---

**Created**: July 31, 2025  
**Last Modified**: July 31, 2025
