# Changing the Database Schema

<!-- omit from toc -->

## Table of Contents

- [Schema Evolution Overview](#schema-evolution-overview)
- [Migration-Based Schema Changes](#migration-based-schema-changes)
- [Demonstrating a Schema Change](#demonstrating-a-schema-change)
  - [Adding a Column Using Visual Tools](#adding-a-column-using-visual-tools)
  - [Creating the Migration File](#creating-the-migration-file)
  - [Applying the Migration](#applying-the-migration)
- [Understanding Migration Immutability](#understanding-migration-immutability)
  - [The Checksum Problem](#the-checksum-problem)
  - [Why Migrations Cannot Be Changed](#why-migrations-cannot-be-changed)
  - [Migration as Git Commits](#migration-as-git-commits)
- [Correcting Migration Mistakes](#correcting-migration-mistakes)
  - [The Forward-Only Approach](#the-forward-only-approach)
  - [Creating Corrective Migrations](#creating-corrective-migrations)
  - [Multi-Step Schema Changes](#multi-step-schema-changes)
- [Best Practices for Schema Changes](#best-practices-for-schema-changes)
- [Key Points](#key-points)
- [Links/References](#linksreferences)

## Schema Evolution Overview

- **Inevitable change**: Real-world applications require database schema evolution
- **Common changes**: Adding tables, modifying columns, fixing constraints
- **Migration approach**: Always create new migrations instead of direct database changes
- **Version control**: Schema changes must be tracked and versioned

![Database Schema Evolution Process](assets/database-schema-evolution-process.png)

**Types of schema changes:**
- Adding new tables
- Modifying existing columns
- Adding or removing constraints
- Restructuring relationships

## Migration-Based Schema Changes

- **Never modify directly**: Avoid making changes directly to database
- **Always use migrations**: Create new migration files for all schema changes
- **Team consistency**: Ensures all environments receive same changes
- **Change tracking**: Maintains history of all schema modifications

![Migration-Based Change Workflow](assets/migration-based-change-workflow.png)

**Benefits of migration approach:**
- Reproducible changes across environments
- Version-controlled schema evolution
- Rollback capabilities
- Team synchronization

## Demonstrating a Schema Change

### Adding a Column Using Visual Tools

- **Example scenario**: Adding a `state` column to addresses table
- **Deliberate mistake**: Adding column to users table first to demonstrate error recovery
- **Visual approach**: Right-click table â†’ "Modify Table"
- **SQL extraction**: Copy generated SQL without applying changes

![Table Modification Dialog](assets/table-modification-dialog.png)

**Visual modification process:**
1. Right-click on users table
2. Select "Modify Table" from context menu
3. Add new column with specifications
4. Copy generated SQL statement
5. Cancel changes (don't apply to database)

![Adding State Column Visual](assets/adding-state-column-visual.png)

**Column specifications:**
- **Column name**: `state`
- **Data type**: `VARCHAR(255)`
- **Constraints**: As needed for business requirements

### Creating the Migration File

- **Naming convention**: `V2__add_state_column.sql`
- **Descriptive names**: Use clear, maintainable descriptions
- **SQL content**: Paste extracted SQL from visual tool

![Migration File Creation V2](assets/migration-file-creation-v2.png)

```sql
-- V2__add_state_column.sql
ALTER TABLE users ADD COLUMN state VARCHAR(255);
```

**Migration file best practices:**
- Sequential version numbers
- Descriptive names for maintenance
- Clear SQL statements
- Single responsibility per migration

### Applying the Migration

- **Application startup**: Run application to apply migration
- **Automatic execution**: Flyway detects and applies new migration
- **Database update**: Schema changes applied automatically
- **Verification**: Check database to confirm changes

![Migration Application Process](assets/migration-application-process.png)

**Application results:**
- New column appears in users table
- Flyway schema history updated
- Migration marked as applied

## Understanding Migration Immutability

### The Checksum Problem

- **Checksum calculation**: Flyway computes checksum based on file content
- **Change detection**: Modified files have different checksums
- **Error condition**: Checksum mismatch prevents application startup
- **Data safety**: Protects against accidental migration corruption

![Flyway Checksum Error](assets/flyway-checksum-error.png)

**Checksum error example:**
```
Validate failed: Migration checksum mismatch for migration version 2
-> Applied to database : 1234567890
-> Resolved locally    : 0987654321
```

**Error analysis:**
- Database shows original checksum
- Local file shows new checksum
- Flyway detects the mismatch
- Application startup fails

### Why Migrations Cannot Be Changed

- **Database integrity**: Applied migrations are permanent record
- **Team synchronization**: Other environments may have applied original migration
- **History preservation**: Migration history must remain consistent
- **Production safety**: Prevents accidental schema corruption

![Migration Immutability Concept](assets/migration-immutability-concept.png)

**Consequences of changing applied migrations:**
- Checksum validation failures
- Environment synchronization issues
- Potential data corruption
- Team workflow disruption

### Migration as Git Commits

- **Linear history**: Migrations form forward-only timeline
- **Commit analogy**: Each migration like a Git commit
- **No rewriting history**: Cannot change past migrations
- **Forward corrections**: Fix mistakes with new migrations

![Migration Timeline Analogy](assets/migration-timeline-analogy.png)

**Git-like properties:**
- Sequential version control
- Immutable history
- Forward-only progression
- Collaborative consistency

## Correcting Migration Mistakes

### The Forward-Only Approach

- **Undo changes**: Revert migration file to original state
- **Restart application**: Clear checksum error
- **Create new migration**: Add corrective migration
- **Never modify applied migrations**: Maintain migration integrity

![Forward-Only Correction Process](assets/forward-only-correction-process.png)

**Correction workflow:**
1. Revert problematic migration file
2. Restart application successfully
3. Create new corrective migration
4. Apply forward-fixing changes

### Creating Corrective Migrations

- **New migration file**: `V3__move_state_from_users_to_addresses.sql`
- **Descriptive naming**: Clear explanation of correction
- **Multi-step process**: Remove from wrong table, add to correct table

![Corrective Migration Creation](assets/corrective-migration-creation.png)

```sql
-- V3__move_state_from_users_to_addresses.sql

-- Step 1: Remove state column from users table
ALTER TABLE users DROP COLUMN state;

-- Step 2: Add state column to addresses table
ALTER TABLE addresses ADD COLUMN state VARCHAR(255) NOT NULL;
```

### Multi-Step Schema Changes

- **Step 1**: Remove column from incorrect table
- **Step 2**: Add column to correct table
- **SQL extraction**: Use visual tools to generate statements
- **Copy without applying**: Extract SQL without executing changes

![Multi-Step Migration SQL](assets/multi-step-migration-sql.png)

**SQL generation process:**
1. Modify users table to remove state column
2. Copy DROP COLUMN statement
3. Cancel changes
4. Modify addresses table to add state column
5. Copy ADD COLUMN statement
6. Cancel changes
7. Combine statements in migration file

**Final verification:**
- State column removed from users table
- State column added to addresses table
- Migration history shows correction
- Database refresh confirms changes

![Schema Change Verification](assets/schema-change-verification.png)

## Best Practices for Schema Changes

- **Always use migrations**: Never modify database schema directly
- **Descriptive naming**: Use clear, maintainable migration names
- **Forward-only fixes**: Create new migrations to correct mistakes
- **Test thoroughly**: Verify changes in development before production
- **Small changes**: Keep migrations focused and atomic
- **Team communication**: Coordinate schema changes with team members

![Schema Change Best Practices](assets/schema-change-best-practices.png)

**Migration best practices:**
- One logical change per migration
- Clear, descriptive migration names
- Test migrations in development environment
- Document complex schema changes
- Coordinate with team on breaking changes

## Key Points

- **Main takeaway**: Database schema changes must always be implemented through new migrations, never by modifying the database directly or changing existing migration files
- **Migration immutability**: Once a migration is applied, it becomes immutable and cannot be changed due to checksum validation that ensures data integrity
- **Forward-only corrections**: Mistakes in migrations must be corrected by creating new migrations rather than modifying existing ones, similar to Git commit history
- **Checksum protection**: Flyway's checksum validation prevents accidental corruption of migration files and ensures consistency across environments
- **Visual tool integration**: Database design tools can generate SQL for migrations, but changes should be extracted as scripts rather than applied directly
- **Multi-step corrections**: Complex corrections may require multiple SQL statements within a single migration file to safely move data or restructure schema
- **Team collaboration**: Migration-based approach ensures all team members and environments receive identical schema changes in correct order
- **Production safety**: Following migration discipline prevents schema inconsistencies that could cause application failures in production
- **Version control**: Migration files should be treated as source code and included in version control for proper change tracking
- **Descriptive naming**: Clear migration names with good descriptions make schema evolution easier to understand and maintain over time

## Links/References

- Video: 4.6.3-Chaning-the-Database-Schema.mp4 (05:02)
- Previous: [Database Migrations with Flyway](4.6.2-Database-Migrations-with-Flyway.md)
- Next: Migration Best Practices and Advanced Techniques

---

**Created**: July 31, 2025  
**Last Modified**: July 31, 2025
